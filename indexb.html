form.addEventListener('submit', async e => {
  e.preventDefault();
  resultDiv.textContent = 'Looking up constituencyâ€¦';

  const postcode = document.getElementById('postcode').value.trim();

  try {
    const res = await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}`);
    const data = await res.json();

    if (!data.result) throw new Error('Invalid postcode');
    if (data.result.country !== 'Wales') {
      resultDiv.textContent = 'Sorry, this tool only supports Welsh postcodes.';
      return;
    }

    const { longitude, latitude } = data.result;
    const userPoint = turf.point([longitude, latitude]);

    const match = boundaries.features.find(f => turf.booleanPointInPolygon(userPoint, f));

    if (!match) {
      resultDiv.textContent = 'Could not find your constituency.';
      return;
    }

    const constituencyName = match.properties.enw_cymrae;
    const slug = constituencyName.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
    const flourishVisId = '23652088'; // Your actual Flourish vis ID
    const embedUrl = `https://public.flourish.studio/visualisation/${flourishVisId}/embed`;

    // Build HTML with placeholder iframe
    resultDiv.innerHTML = `
      <p>Your 2026 Senedd constituency is: <a href="cons/${slug}.html" class="const-name" target="_blank" rel="noopener">${constituencyName}</a></p>
      <iframe class="flourish-embed" src="${embedUrl}" title="Map showing ${constituencyName} constituency" id="flourish-frame"></iframe>
    `;

    // Wait for the iframe to load, then send the highlight
    const iframe = document.getElementById('flourish-frame');
    iframe.addEventListener('load', () => {
      iframe.contentWindow.postMessage({
        type: 'highlight',
        payload: constituencyName
      }, '*');
    });

  } catch (err) {
    resultDiv.textContent = 'Something went wrong. Please check your postcode and try again.';
    console.error(err);
  }
});
