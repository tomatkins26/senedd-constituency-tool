<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Senedd Constituency Lookup</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans p-4">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md space-y-4">
    <h1 class="text-2xl font-bold">Find Your Senedd Constituency</h1>

    <div>
      <label class="block mb-1 font-semibold">Enter your postcode:</label>
      <input id="postcode" type="text" class="w-full border p-2 rounded" placeholder="e.g. CF10 1EP" />
      <button id="lookup" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Look up</button>
    </div>

    <div id="boundaryWarning" class="text-yellow-600 text-sm hidden">
      You're within 1km of a constituency boundary. Please enter your full address for better accuracy:
    </div>

    <div id="addressFallback" class="hidden mt-4">
      <label class="block mb-1 font-semibold">Address line (e.g. 10 Queen Street):</label>
      <input id="addressLine" type="text" class="w-full border p-2 rounded" placeholder="e.g. 10 Queen Street" />
      <button id="addressSubmit" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit full address</button>
    </div>

    <div id="result" class="mt-4 text-lg font-medium"></div>
    <div id="loading" class="text-blue-600 font-semibold hidden">Loading...</div>
  </div>

  <script>
    const postcodeInput = document.getElementById('postcode');
    const lookupButton = document.getElementById('lookup');
    const resultDiv = document.getElementById('result');
    const boundaryWarning = document.getElementById('boundaryWarning');
    const addressFallback = document.getElementById('addressFallback');
    const addressInput = document.getElementById('addressLine');
    const addressSubmit = document.getElementById('addressSubmit');
    const loading = document.getElementById('loading');

    let boundaries;

    // Load constituency boundaries (GeoJSON)
    async function loadBoundaries() {
      const response = await fetch('senedd_constituencies.geojson'); // Ensure this file exists
      boundaries = await response.json();
    }

    function startProgress() {
      resultDiv.textContent = '';
      loading.classList.remove('hidden');
    }

    function stopProgress(message = '') {
      loading.classList.add('hidden');
      resultDiv.textContent = message;
    }

    function cleanAddressLine(address, postcode) {
      return address.replace(postcode, '').trim();
    }

    function renderConstituency(feature) {
      const name = feature.properties.constituency || feature.properties.name;
      stopProgress(`Your Senedd constituency is: ${name}`);
    }

    // Postcode lookup
    lookupButton.addEventListener('click', async () => {
      const postcode = postcodeInput.value.trim().replace(/\s+/g, '');
      if (!postcode) return alert('Please enter a valid postcode.');

      resultDiv.textContent = '';
      boundaryWarning.classList.add('hidden');
      addressFallback.classList.add('hidden');
      startProgress();

      try {
        const res = await fetch(`https://api.postcodes.io/postcodes/${postcode}`);
        const data = await res.json();
        if (!data.result) throw new Error('Postcode not found');

        const { longitude, latitude } = data.result;
        const userPoint = turf.point([longitude, latitude]);

        let matchedFeature = null;
        let minDistance = Infinity;

        for (const feature of boundaries.features) {
          const polygon = feature;
          const inside = turf.booleanPointInPolygon(userPoint, polygon);
          const dist = turf.pointToPolygonDistance(userPoint, polygon, { units: 'kilometers' });

          if (inside) {
            matchedFeature = feature;
            break;
          }

          if (dist < minDistance) {
            minDistance = dist;
          }
        }

        if (matchedFeature) {
          renderConstituency(matchedFeature);
        } else if (minDistance < 1) {
          stopProgress();
          boundaryWarning.classList.remove('hidden');
          addressFallback.classList.remove('hidden');
        } else {
          stopProgress('Location not found in any Senedd constituency.');
        }
      } catch (err) {
        stopProgress('Error looking up postcode.');
        console.error(err);
      }
    });

    // Full address lookup
    addressSubmit.addEventListener('click', async () => {
      const addressLine = addressInput.value.trim();
      const postcode = postcodeInput.value.trim().replace(/\s+/g, '');

      if (!addressLine) {
        alert('Please enter an address line.');
        return;
      }

      resultDiv.textContent = '';
      startProgress();

      try {
        const cleaned = cleanAddressLine(addressLine, postcode);
        const query = encodeURIComponent(`${cleaned} ${postcode}`);
        const apiKey = 'bIFf8Sc6M0WyEvHy31Vguw46656'; // Replace with your own key
        const url = `https://api.getaddress.io/geocode?api-key=${apiKey}&q=${query}`;

        const res = await fetch(url);
        const data = await res.json();

        if (!data || !data.latitude || !data.longitude) {
          stopProgress('Could not geocode the full address.');
          return;
        }

        const { latitude, longitude } = data;
        const userPoint = turf.point([longitude, latitude]);

        let matchedFeature = null;
        for (const feature of boundaries.features) {
          if (turf.booleanPointInPolygon(userPoint, feature)) {
            matchedFeature = feature;
            break;
          }
        }

        if (matchedFeature) {
          renderConstituency(matchedFeature);
        } else {
          stopProgress('Address is outside the Senedd boundaries.');
        }
      } catch (err) {
        stopProgress('Error processing address.');
        console.error(err);
      }
    });

    loadBoundaries();
  </script>
</body>
</html>
